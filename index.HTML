import React, { useState, useEffect } from 'react';
import { Plus, Trash2, AlertCircle, Search, Save, BarChart3, Sparkles, Loader2, X, Edit2, CheckCircle, RotateCcw, Archive, Printer, FileSpreadsheet, Filter, ArrowUpDown, Scale, Wifi, WifiOff, Undo2 } from 'lucide-react';

// Firebase Modülleri
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from 'firebase/firestore';

export default function App() {
  // --- FIREBASE KURULUMU ---
  const [user, setUser] = useState(null);
  const [db, setDb] = useState(null);
  const [appId, setAppId] = useState(null);
  const [isOnline, setIsOnline] = useState(false);

  useEffect(() => {
    // Firebase Başlatma
    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);
    const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    setDb(firestore);
    setAppId(currentAppId);

    // Anonim Giriş (Herkes düzenleyebilir modülü için)
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
           await signInWithCustomToken(auth, __initial_auth_token);
        } else {
           await signInAnonymously(auth);
        }
      } catch (error) {
        console.error("Giriş hatası:", error);
      }
    };

    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => {
      setUser(u);
      setIsOnline(!!u);
    });

    return () => unsubscribe();
  }, []);

  // --- VERİ ÇEKME (REALTIME) ---
  const [entries, setEntries] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user || !db) return;

    // PUBLİC KOLEKSİYON: Herkesin görüp düzenleyebileceği alan
    const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2');

    const unsubscribe = onSnapshot(collectionRef, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setEntries(data);
      setLoading(false);
    }, (error) => {
      console.error("Veri çekme hatası:", error);
      setLoading(false);
    });

    return () => unsubscribe();
  }, [user, db, appId]);

  // --- STATE TANIMLARI ---
  // Not: entries artık yukarıdaki useEffect ile Firebase'den geliyor.
  
  const [formData, setFormData] = useState({
    date: new Date().toISOString().split('T')[0],
    batchNo: '',
    firm: '',
    fabric: '',
    kg: '',
    defect: '',
    solution: '',
    isArchived: false
  });

  const [editingId, setEditingId] = useState(null);
  const [viewMode, setViewMode] = useState('active'); // active | archived
  const [searchTerm, setSearchTerm] = useState('');
  
  // Filtreleme ve Sıralama State'leri
  const [filterType, setFilterType] = useState('all'); // all | delayed | high_kg
  const [sortConfig, setSortConfig] = useState({ key: 'date', direction: 'desc' });

  // Modal State'leri
  const [deleteConfirmation, setDeleteConfirmation] = useState(null);
  const [showAnalysisModal, setShowAnalysisModal] = useState(false);
  
  // AI State'leri
  const [isSuggesting, setIsSuggesting] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [analysisResult, setAnalysisResult] = useState(null);

  // --- YENİ: GERİ AL (UNDO) STATE ---
  const [lastDeletedItem, setLastDeletedItem] = useState(null);
  const [showUndoToast, setShowUndoToast] = useState(false);

  // --- GENEL FONKSİYONLAR ---
  const calculateDays = (dateString) => {
    if (!dateString) return 0;
    const start = new Date(dateString);
    const today = new Date();
    return Math.floor((today - start) / (1000 * 60 * 60 * 24));
  };

  // --- YAZDIRMA VE EXCEL ---
  const handlePrint = () => {
    window.print();
  };

  const handleExportExcel = () => {
    const dataToExport = displayedEntries;
    const headers = ["Tarih", "Parti No", "Firma", "Kumaş", "KG", "Hata", "Çözüm", "Durum", "Bekleme Süresi"];
    
    const csvRows = [
      headers.join(";"),
      ...dataToExport.map(row => [
        row.date,
        row.batchNo,
        row.firm,
        row.fabric,
        row.kg,
        row.defect,
        row.solution,
        row.isArchived ? "Tamamlandı" : "Aktif",
        calculateDays(row.date) + " Gün"
      ].map(e => `"${e}"`).join(";"))
    ].join("\n");

    const bom = "\uFEFF"; 
    const blob = new Blob([bom + csvRows], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', `Ortak_Tekstil_Raporu_${new Date().toLocaleDateString()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // --- CRUD İŞLEMLERİ (FIREBASE) ---
  const handleSave = async (e) => {
    e.preventDefault();
    if (!formData.batchNo || !formData.firm) return alert("Lütfen zorunlu alanları doldurun.");
    if (!user) return alert("Bağlantı yok, lütfen sayfayı yenileyin.");

    try {
      if (editingId) {
        // Güncelleme
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2', editingId);
        await updateDoc(docRef, formData);
        setEditingId(null);
      } else {
        // Yeni Kayıt Ekleme
        const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2');
        await addDoc(collectionRef, { ...formData, createdAt: Date.now() });
      }
      
      // Formu temizle
      setFormData({ 
        date: new Date().toISOString().split('T')[0],
        batchNo: '', firm: '', fabric: '', kg: '', defect: '', solution: '', isArchived: false 
      });
    } catch (error) {
      console.error("Kaydetme hatası:", error);
      alert("İşlem başarısız oldu.");
    }
  };

  const handleEdit = (item) => {
    setFormData({
        date: item.date || '',
        batchNo: item.batchNo || '',
        firm: item.firm || '',
        fabric: item.fabric || '',
        kg: item.kg || '',
        defect: item.defect || '',
        solution: item.solution || '',
        isArchived: item.isArchived || false
    });
    setEditingId(item.id);
    setViewMode('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const toggleArchive = async (id, currentStatus) => {
    if (!user) return;
    try {
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2', id);
        await updateDoc(docRef, { isArchived: !currentStatus });
    } catch (error) {
        console.error("Arşivleme hatası:", error);
    }
  };

  const confirmDelete = async () => {
    if (deleteConfirmation && user) {
      // 1. Silinecek veriyi bul ve sakla
      const itemToDelete = entries.find(item => item.id === deleteConfirmation);
      if (itemToDelete) {
        setLastDeletedItem(itemToDelete);
        setShowUndoToast(true);
        // 5 saniye sonra bildirimi kaldır
        setTimeout(() => setShowUndoToast(false), 5000);
      }

      try {
        // 2. Veritabanından sil
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2', deleteConfirmation);
        await deleteDoc(docRef);
        setDeleteConfirmation(null);
        if (editingId === deleteConfirmation) {
            setEditingId(null);
            setFormData({ date: new Date().toISOString().split('T')[0], batchNo: '', firm: '', fabric: '', kg: '', defect: '', solution: '', isArchived: false });
        }
      } catch (error) {
          console.error("Silme hatası:", error);
      }
    }
  };

  // --- GERİ AL (UNDO) FONKSİYONU ---
  const handleUndo = async () => {
    if (!lastDeletedItem || !user) return;
    
    try {
      // Silinen veriyi tekrar ekle (yeni bir ID ile eklenecektir ama veri aynıdır)
      const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'tekstil_hatalar_v2');
      const { id, ...dataToRestore } = lastDeletedItem; // ID hariç veriyi al
      await addDoc(collectionRef, dataToRestore);
      
      setShowUndoToast(false); // Bildirimi kapat
      setLastDeletedItem(null); // Hafızayı temizle
    } catch (error) {
      console.error("Geri alma hatası:", error);
      alert("Geri alma işlemi başarısız oldu.");
    }
  };

  const getBarColor = (days) => {
    if (days >= 3) return 'bg-red-600';
    if (days === 2) return 'bg-orange-400';
    return 'bg-green-500';
  };

  // --- SORT VE FILTER ---
  const handleSort = (key) => {
    let direction = 'asc';
    if (sortConfig.key === key && sortConfig.direction === 'asc') {
      direction = 'desc';
    }
    setSortConfig({ key, direction });
  };

  // --- AI İŞLEMLERİ ---
  const apiKey = ""; 

  const suggestSolution = async () => {
    if (!formData.defect) return alert("Lütfen önce bir hata adı girin.");
    setIsSuggesting(true);
    try {
      const prompt = `Tekstil: '${formData.fabric}' kumaşta '${formData.defect}' hatası için tek kelime çözüm önerisi (örn: 'Yıkama'). Türkçe.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      const suggestion = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "Öneri Yok";
      setFormData({ ...formData, solution: suggestion.replace(/['"]/g, '') });
    } catch (error) { console.error("AI Hatası:", error); } finally { setIsSuggesting(false); }
  };

  const analyzeData = async () => {
    const activeData = entries.filter(e => !e.isArchived);
    if (activeData.length === 0) return alert("Analiz edilecek veri yok.");
    setIsAnalyzing(true);
    setShowAnalysisModal(true);
    setAnalysisResult(null);
    try {
      const dataSummary = JSON.stringify(activeData.map(e => ({ firma: e.firm, hata: e.defect, gecenGun: calculateDays(e.date) })));
      const prompt = `Tekstil hata verileri: ${dataSummary}. Türkçe özetle: 1. Sorunlu Firma? 2. Sık Hata? 3. Riskler.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      setAnalysisResult(data.candidates?.[0]?.content?.parts?.[0]?.text || "Hata.");
    } catch (error) { setAnalysisResult("Hata oluştu."); } finally { setIsAnalyzing(false); }
  };

  // --- FİLTRELEME MANTIĞI ---
  const displayedEntries = entries
    .filter(item => viewMode === 'active' ? !item.isArchived : item.isArchived)
    .filter(item => 
      (item.firm || '').toLowerCase().includes(searchTerm.toLowerCase()) || 
      (item.batchNo || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
      (item.defect || '').toLowerCase().includes(searchTerm.toLowerCase())
    )
    .filter(item => {
      if (filterType === 'delayed') return calculateDays(item.date) >= 3;
      if (filterType === 'high_kg') return Number(item.kg) > 200;
      return true;
    })
    .sort((a, b) => {
      if (sortConfig.key === 'date') {
        return sortConfig.direction === 'asc' 
          ? new Date(a.date) - new Date(b.date) 
          : new Date(b.date) - new Date(a.date);
      }
      if (sortConfig.key === 'kg') {
        return sortConfig.direction === 'asc' 
          ? Number(a.kg) - Number(b.kg) 
          : Number(b.kg) - Number(a.kg);
      }
      if (sortConfig.key === 'firm') {
        return sortConfig.direction === 'asc' 
          ? (a.firm || '').localeCompare(b.firm || '') 
          : (b.firm || '').localeCompare(a.firm || '');
      }
      return 0;
    });

  return (
    <div className="min-h-screen bg-gray-50 p-4 font-sans text-gray-800 relative">
      <style>{`
        @media print {
          .no-print { display: none !important; }
          .print-only { display: block !important; }
          body { background: white; }
          .shadow-sm { box-shadow: none !important; border: 1px solid #ccc; }
          table { width: 100%; }
          th:last-child, td:last-child { display: none; }
        }
      `}</style>

      <div className="max-w-6xl mx-auto">
        
        {/* SİLME MODALI */}
        {deleteConfirmation && (
          <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 no-print">
            <div className="bg-white rounded-lg p-6 max-w-sm w-full shadow-xl">
              <h3 className="text-lg font-bold text-gray-900 mb-2">Ortak Kaydı Sil?</h3>
              <p className="text-gray-600 mb-6">Bu işlem <b>herkesten</b> silinecektir.</p>
              <div className="flex justify-end gap-3">
                <button onClick={() => setDeleteConfirmation(null)} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Vazgeç</button>
                <button onClick={confirmDelete} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Sil</button>
              </div>
            </div>
          </div>
        )}

        {/* GERİ AL (UNDO) TOAST BİLDİRİMİ */}
        {showUndoToast && (
          <div className="fixed bottom-6 right-6 z-[70] no-print animate-bounce-in">
            <div className="bg-gray-900 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-4">
              <span>Kayıt silindi.</span>
              <button 
                onClick={handleUndo} 
                className="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md text-sm font-semibold flex items-center gap-2 transition"
              >
                <Undo2 className="w-4 h-4" /> Geri Al
              </button>
              <button onClick={() => setShowUndoToast(false)} className="text-gray-400 hover:text-white"><X className="w-4 h-4"/></button>
            </div>
          </div>
        )}

        {/* ANALİZ MODALI */}
        {showAnalysisModal && (
          <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 no-print">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
              <div className="p-6 border-b flex justify-between items-center bg-indigo-50 rounded-t-xl">
                <h3 className="text-xl font-bold text-indigo-900 flex items-center gap-2">
                  <Sparkles className="w-5 h-5 text-indigo-600" />
                  Yapay Zeka Durum Analizi
                </h3>
                <button onClick={() => setShowAnalysisModal(false)}><X className="w-6 h-6 text-gray-500" /></button>
              </div>
              <div className="p-6">
                {isAnalyzing ? (
                  <div className="flex flex-col items-center justify-center py-12 text-gray-500">
                    <Loader2 className="w-12 h-12 animate-spin text-indigo-500 mb-4" />
                    <p>Veriler inceleniyor...</p>
                  </div>
                ) : (
                  <div className="prose prose-indigo max-w-none text-gray-700 whitespace-pre-wrap">{analysisResult}</div>
                )}
              </div>
              <div className="p-4 border-t bg-gray-50 text-right"><button onClick={() => setShowAnalysisModal(false)} className="px-6 py-2 bg-indigo-600 text-white rounded-lg">Tamam</button></div>
            </div>
          </div>
        )}

        {/* YAZDIRMA BAŞLIĞI */}
        <div className="hidden print-only mb-6 text-center border-b pb-4">
            <h1 className="text-2xl font-bold">Tekstil Hata Kontrol Raporu</h1>
            <p className="text-sm text-gray-600">Rapor Tarihi: {new Date().toLocaleDateString('tr-TR')}</p>
        </div>

        {/* HEADER */}
        <header className="mb-6 bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 no-print">
          <div>
            <h1 className="text-2xl font-bold text-indigo-900 flex items-center gap-2">
              <BarChart3 className="w-8 h-8 text-indigo-600" />
              Tekstil Hata Takip
            </h1>
            <div className="flex items-center gap-2 mt-1">
                {isOnline ? (
                    <span className="text-xs text-green-600 flex items-center gap-1 font-medium bg-green-50 px-2 py-0.5 rounded-full"><Wifi className="w-3 h-3"/> Canlı Veri (Ortak)</span>
                ) : (
                    <span className="text-xs text-red-500 flex items-center gap-1 font-medium bg-red-50 px-2 py-0.5 rounded-full"><WifiOff className="w-3 h-3"/> Bağlantı Bekleniyor...</span>
                )}
            </div>
          </div>
          <div className="flex flex-wrap gap-2 items-center">
             <button onClick={handlePrint} className="bg-white text-gray-700 px-3 py-2 rounded-lg border border-gray-300 flex items-center gap-2 font-medium text-sm hover:bg-gray-50 transition shadow-sm">
               <Printer className="w-4 h-4" /> Yazdır
             </button>
             <button onClick={handleExportExcel} className="bg-emerald-600 text-white px-3 py-2 rounded-lg border border-emerald-700 flex items-center gap-2 font-medium text-sm hover:bg-emerald-700 transition shadow-sm">
               <FileSpreadsheet className="w-4 h-4" /> Excel
             </button>
             <div className="w-px h-6 bg-gray-300 mx-2 hidden md:block"></div>
             
             <button onClick={analyzeData} className="bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg border border-indigo-200 flex items-center gap-2 font-semibold text-sm hover:bg-indigo-200 transition">
               <Sparkles className="w-4 h-4" /> AI Analiz
             </button>
          </div>
        </header>

        {/* FORM */}
        <div className={`bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-8 relative transition-all no-print ${editingId ? 'ring-2 ring-yellow-400' : ''}`}>
          {editingId && (
            <div className="absolute top-0 left-0 w-full bg-yellow-50 text-yellow-700 text-xs py-1 px-4 font-bold border-b border-yellow-200 flex justify-between items-center">
              <span>DÜZENLEME MODU: Kayıt herkes için güncelleniyor...</span>
              <button onClick={() => { setEditingId(null); setFormData({ ...formData, batchNo: '', firm: '' }); }} className="underline">İptal</button>
            </div>
          )}
          
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2 text-gray-700 mt-2">
            {editingId ? <Edit2 className="w-5 h-5 text-yellow-600" /> : <Plus className="w-5 h-5" />} 
            {editingId ? 'Kaydı Düzenle' : 'Yeni Kayıt Ekle'}
          </h2>
          
          <form onSubmit={handleSave} className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="md:col-span-1">
              <label className="text-xs text-gray-500 mb-1 block">Tarih</label>
              <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" required />
            </div>
            <div className="md:col-span-1">
              <label className="text-xs text-gray-500 mb-1 block">Parti No</label>
              <input type="text" placeholder="örn: P-101" value={formData.batchNo} onChange={e => setFormData({...formData, batchNo: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" required />
            </div>
            <div className="md:col-span-1">
               <label className="text-xs text-gray-500 mb-1 block">Firma Adı</label>
               <input type="text" placeholder="Firma" value={formData.firm} onChange={e => setFormData({...formData, firm: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" required />
            </div>
            <div className="md:col-span-1">
              <label className="text-xs text-gray-500 mb-1 block">Kumaş Cinsi</label>
              <input type="text" placeholder="Pamuk..." value={formData.fabric} onChange={e => setFormData({...formData, fabric: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" />
            </div>
            <div className="md:col-span-1">
              <label className="text-xs text-gray-500 mb-1 block">KG (Miktar)</label>
              <input type="number" placeholder="KG" value={formData.kg} onChange={e => setFormData({...formData, kg: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" />
            </div>
            <div className="md:col-span-1">
               <label className="text-xs text-gray-500 mb-1 block">Hata Adı</label>
               <input type="text" placeholder="Hata..." value={formData.defect} onChange={e => setFormData({...formData, defect: e.target.value})} className="w-full border p-2 rounded focus:ring-2 focus:ring-indigo-200 outline-none" />
            </div>
            <div className="md:col-span-1 relative">
               <label className="text-xs text-gray-500 mb-1 block flex justify-between">
                 <span>Çözüm</span> <span className="text-[10px] text-indigo-500 font-medium cursor-pointer" onClick={suggestSolution}>✨ AI Önerisi</span>
               </label>
               <div className="flex gap-1">
                 <input type="text" placeholder="Çözüm" value={formData.solution} onChange={e => setFormData({...formData, solution: e.target.value})} className="w-full border p-2 rounded-l focus:ring-2 focus:ring-indigo-200 outline-none" />
                 <button type="button" onClick={suggestSolution} disabled={isSuggesting} className="bg-indigo-100 text-indigo-600 px-3 rounded-r border border-l-0 border-indigo-200">
                   {isSuggesting ? <Loader2 className="w-4 h-4 animate-spin" /> : <Sparkles className="w-4 h-4" />}
                 </button>
               </div>
            </div>
            <div className="md:col-span-1 flex items-end">
              <button type="submit" disabled={!isOnline} className={`w-full ${editingId ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'} text-white font-semibold p-2 rounded transition flex items-center justify-center gap-2 h-[42px] disabled:opacity-50`}>
                <Save className="w-4 h-4" /> {editingId ? 'Güncelle' : 'Kaydet'}
              </button>
            </div>
          </form>
        </div>

        {/* KONTROL PANELİ */}
        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mb-6 flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 no-print">
            <div className="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                <div className="flex bg-gray-100 p-1 rounded-lg self-start">
                    <button onClick={() => setViewMode('active')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'active' ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`}>Aktif</button>
                    <button onClick={() => setViewMode('archived')} className={`px-3 py-1.5 rounded-md text-sm font-medium transition ${viewMode === 'archived' ? 'bg-white shadow text-indigo-700' : 'text-gray-500'}`}>Arşiv</button>
                </div>
                <div className="flex items-center gap-2 overflow-x-auto pb-1 sm:pb-0">
                    <span className="text-sm text-gray-400 flex items-center gap-1"><Filter className="w-3 h-3"/> Filtre:</span>
                    <button onClick={() => setFilterType('all')} className={`px-3 py-1.5 rounded-full text-xs font-medium border transition whitespace-nowrap ${filterType === 'all' ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}>Tümü</button>
                    <button onClick={() => setFilterType('delayed')} className={`px-3 py-1.5 rounded-full text-xs font-medium border transition whitespace-nowrap flex items-center gap-1 ${filterType === 'delayed' ? 'bg-red-50 border-red-200 text-red-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}><AlertCircle className="w-3 h-3" /> Gecikenler</button>
                    <button onClick={() => setFilterType('high_kg')} className={`px-3 py-1.5 rounded-full text-xs font-medium border transition whitespace-nowrap flex items-center gap-1 ${filterType === 'high_kg' ? 'bg-orange-50 border-orange-200 text-orange-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'}`}><Scale className="w-3 h-3" /> Yüksek KG ({'>'}200)</button>
                </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-3 w-full lg:w-auto items-center">
                <div className="relative w-full sm:w-auto">
                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><ArrowUpDown className="h-4 w-4 text-gray-400" /></div>
                    <select className="block w-full sm:w-40 pl-9 pr-8 py-2 text-sm border border-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 appearance-none bg-white" onChange={(e) => { const [key, direction] = e.target.value.split('-'); setSortConfig({ key, direction }); }} value={`${sortConfig.key}-${sortConfig.direction}`}>
                        <option value="date-desc">Tarih (Yeni)</option>
                        <option value="date-asc">Tarih (Eski)</option>
                        <option value="kg-desc">KG (Çok)</option>
                        <option value="kg-asc">KG (Az)</option>
                        <option value="firm-asc">Firma (A-Z)</option>
                        <option value="firm-desc">Firma (Z-A)</option>
                    </select>
                </div>
                <div className="relative w-full sm:w-64">
                    <Search className="absolute left-3 top-2.5 w-4 h-4 text-gray-400" />
                    <input type="text" placeholder="Ara..." className="w-full pl-9 p-2 text-sm rounded-lg border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-200" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                </div>
            </div>
        </div>

        {/* TABLO */}
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden min-h-[300px]">
          <div className="overflow-x-auto">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="bg-gray-50 text-gray-600 text-xs uppercase tracking-wider">
                  <th className="p-4 border-b cursor-pointer hover:bg-gray-100" onClick={() => handleSort('date')}>Tarih</th>
                  <th className="p-4 border-b">Parti</th>
                  <th className="p-4 border-b cursor-pointer hover:bg-gray-100" onClick={() => handleSort('firm')}>Firma / Kumaş</th>
                  <th className="p-4 border-b text-center cursor-pointer hover:bg-gray-100" onClick={() => handleSort('kg')}>Miktar (KG)</th>
                  <th className="p-4 border-b">Hata / Çözüm</th>
                  <th className="p-4 border-b w-40">Durum</th>
                  <th className="p-4 border-b text-right no-print">İşlemler</th>
                </tr>
              </thead>
              <tbody className="text-sm">
                {loading ? (
                  <tr><td colSpan="7" className="p-8 text-center text-gray-500"><Loader2 className="w-8 h-8 animate-spin mx-auto mb-2 text-indigo-500"/>Veriler yükleniyor...</td></tr>
                ) : displayedEntries.length === 0 ? (
                  <tr><td colSpan="7" className="p-8 text-center text-gray-400">Kayıt bulunamadı.</td></tr>
                ) : displayedEntries.map((item) => {
                  const daysPassed = calculateDays(item.date);
                  const progressWidth = Math.min((daysPassed / 3) * 100, 100);
                  
                  return (
                    <tr key={item.id} className={`hover:bg-gray-50 transition border-b last:border-0 ${editingId === item.id ? 'bg-yellow-50' : ''}`}>
                      <td className="p-4 whitespace-nowrap font-medium text-gray-700">{item.date}</td>
                      <td className="p-4 text-indigo-600 font-semibold">{item.batchNo}</td>
                      <td className="p-4">
                        <div className="font-bold text-gray-800">{item.firm}</div>
                        <div className="text-gray-500 text-xs">{item.fabric}</div>
                      </td>
                      <td className="p-4 text-center font-mono font-medium text-gray-700">{item.kg}</td>
                      <td className="p-4">
                        <div className="text-red-600 font-medium">{item.defect}</div>
                        <div className="text-green-600 text-xs mt-1">{item.solution}</div>
                      </td>
                      <td className="p-4">
                        {viewMode === 'active' ? (
                            <div className="flex flex-col gap-1">
                            <div className="flex justify-between text-[10px] font-bold mb-1">
                                <span>{daysPassed} Gün</span>
                                {daysPassed >= 3 && <span className="text-red-600 flex items-center gap-1"><AlertCircle className="w-3 h-3"/> Gecikti</span>}
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden print:border print:border-gray-400">
                                <div className={`h-2 rounded-full transition-all duration-500 ${getBarColor(daysPassed)} print:bg-gray-800`} style={{ width: `${progressWidth}%` }}></div>
                            </div>
                            </div>
                        ) : (
                            <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-semibold">
                                <CheckCircle className="w-3 h-3" /> Tamamlandı
                            </span>
                        )}
                      </td>
                      <td className="p-4 text-right no-print">
                        <div className="flex justify-end gap-2">
                            {viewMode === 'active' && (
                                <button onClick={() => handleEdit(item)} className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition"><Edit2 className="w-4 h-4" /></button>
                            )}
                            <button onClick={() => toggleArchive(item.id, item.isArchived)} className={`p-2 rounded-lg transition ${viewMode === 'active' ? 'text-green-600 hover:bg-green-50' : 'text-orange-600 hover:bg-orange-50'}`}>
                                {viewMode === 'active' ? <CheckCircle className="w-4 h-4" /> : <RotateCcw className="w-4 h-4" />}
                            </button>
                            <button onClick={() => setDeleteConfirmation(item.id)} className="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition"><Trash2 className="w-4 h-4" /></button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  );
}